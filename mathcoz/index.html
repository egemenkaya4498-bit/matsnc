<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATH CANAVARI | KAYA STUDIOS</title>
    <style>
        /* Modern CSS buraya (Önceki tasarımın aynısı + sidebar geliştirmesi) */
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;600;800&family=Syncopate:wght@700&display=swap');
        :root { --primary: #00f2ff; --secondary: #7000ff; --bg: #050505; --glass: rgba(255,255,255,0.05); }
        body { background: var(--bg); color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; display: flex; height: 100vh; margin:0; }
        
        .sidebar { width: 300px; background: #0a0a0a; border-right: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; padding: 20px; }
        .new-chat-btn { background: var(--secondary); border: none; color: white; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-bottom: 20px; }
        .history-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .history-item { padding: 12px; background: var(--glass); border-radius: 8px; cursor: pointer; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-item:hover { background: rgba(0,242,255,0.1); }
        
        .chat-container { flex: 1; display: flex; flex-direction: column; }
        #chatBox { flex: 1; overflow-y: auto; padding: 40px 10%; display: flex; flex-direction: column; gap: 20px; }
        .msg { max-width: 80%; padding: 15px; border-radius: 15px; line-height: 1.5; }
        .user-msg { align-self: flex-end; background: var(--secondary); }
        .ai-msg { align-self: flex-start; background: var(--glass); border: 1px solid rgba(255,255,255,0.1); }
        
        .input-panel { padding: 20px 10%; background: linear-gradient(transparent, var(--bg)); }
        .input-wrapper { background: #111; border: 1px solid #222; border-radius: 20px; padding: 10px 20px; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; background: transparent; border: none; color: #fff; outline: none; }
        button#sendBtn { background: var(--primary); border: none; padding: 10px 20px; border-radius: 12px; font-weight: 800; cursor: pointer; }
    </style>
</head>
<body>

<div class="sidebar">
    <button class="new-chat-btn" onclick="createNewChat()">+ YENİ SOHBET</button>
    <div class="history-list" id="historyList"></div>
</div>

<div class="chat-container">
    <div id="chatBox"></div>
    <div class="input-panel">
        <div class="input-wrapper">
            <input type="text" id="userInput" placeholder="Sorunu sor Egemen...">
            <button id="sendBtn" onclick="sendMessage()">TARA</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC-THkxhmLBkKtST5iFMIHEDYvWmy0bbNA",
        authDomain: "kayastudiosai.firebaseapp.com",
        databaseURL: "https://kayastudiosai-default-rtdb.firebaseio.com",
        projectId: "kayastudiosai",
        storageBucket: "kayastudiosai.firebasestorage.app",
        messagingSenderId: "885497166483",
        appId: "1:885497166483:web:7276aaee1dfa6e0f042b66"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let currentChatId = Date.now().toString();

    // Sohbet Geçmişini Yükle
    function loadSidebar() {
        const historyRef = ref(db, 'chats');
        onValue(historyRef, (snapshot) => {
            const list = document.getElementById('historyList');
            list.innerHTML = "";
            snapshot.forEach((child) => {
                const data = child.val();
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerText = data.title || "Yeni Sohbet";
                div.onclick = () => loadChat(child.key);
                list.appendChild(div);
            });
        });
    }

    // Belirli bir sohbeti ekrana getir
    window.loadChat = (id) => {
        currentChatId = id;
        const chatRef = ref(db, `chats/${id}/messages`);
        get(chatRef).then(snapshot => {
            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML = "";
            snapshot.forEach(msg => {
                const data = msg.val();
                renderMessage(data.role, data.text);
            });
        });
    };

    window.createNewChat = () => {
        currentChatId = Date.now().toString();
        document.getElementById('chatBox').innerHTML = "";
        renderMessage('ai', "Yeni bir sayfa açtık. Nasıl yardımcı olabilirim?");
    };

    async function sendMessage() {
        const input = document.getElementById('userInput');
        const text = input.value;
        if(!text) return;

        renderMessage('user', text);
        input.value = "";

        // Firebase'e kaydet (Kullanıcı)
        const msgRef = ref(db, `chats/${currentChatId}/messages`);
        push(msgRef, { role: 'user', text: text });
        set(ref(db, `chats/${currentChatId}/title`), text.substring(0, 25));

        try {
            const response = await fetch('/.netlify/functions/chat', {
                method: 'POST',
                body: JSON.stringify({ message: text, chatId: currentChatId })
            });
            const data = await response.json();
            
            renderMessage('ai', data.text);
            push(msgRef, { role: 'ai', text: data.text });
        } catch (e) {
            renderMessage('ai', "Hata: Sunucu uyanamadı.");
        }
    }

    function renderMessage(role, text) {
        const box = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = `msg ${role === 'user' ? 'user-msg' : 'ai-msg'}`;
        div.innerText = text;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    window.sendMessage = sendMessage;
    loadSidebar();
</script>
</body>
</html>
